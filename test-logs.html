<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Log</title>
    <link rel="icon" href="fleetLogo.png" type="image/png">
    <link rel="stylesheet" href="test.css">
    <script src="https://apis.google.com/js/api.js"></script> <!-- ‚úÖ Load Google API -->
</head>

<body>
    <header>
        <div id="logoContainer">
            <img src="logo-business-card-style.png" alt="Turf LC Logo" id="companyLogo">
        </div>
        <h1>Truck Maintenance Log</h1>
    </header>

    <div class="log-container">
        <!-- Edit Button (Top Right) -->
        <button class="edit-btn" onclick="openEditForm()">‚úèÔ∏è Edit Truck Details</button>

        <!-- Centered Truck Title -->
        <h2 id="truckTitle" class="centered-title"></h2>

        <!-- Truck Details (Populated Dynamically) -->
        <div id="truckDetails" class="truck-details"></div>

        <!-- Maintenance History -->
        <h3>Maintenance History</h3>
        <ul id="maintenanceList"></ul>
        <div class="entry-container">
            <input type="text" id="maintenanceInput" placeholder="Enter maintenance details...">
            <button class="add-entry-btn" onclick="addEntry('maintenanceList', 'maintenanceInput')">Add Entry</button>
        </div>

        <!-- Repairs Needed -->
        <h3>Repairs Needed</h3>
        <ul id="repairsList"></ul>
        <div class="entry-container">
            <input type="text" id="repairInput" placeholder="Enter repair details...">
            <button class="add-entry-btn" onclick="addEntry('repairsList', 'repairInput')">Add Entry</button>
        </div>

        <!-- Notes Section -->
        <h3>Notes</h3>
        <ul id="notesList"></ul>
        <div class="entry-container">
            <input type="text" id="notesInput" placeholder="Enter notes...">
            <button class="add-entry-btn" onclick="addEntry('notesList', 'notesInput')">Add Entry</button>
        </div>

        <!-- Bottom Buttons -->
        <div class="bottom-buttons">
            <button id="exportPDF">Export Log as PDF</button>
            <button onclick="window.location.href='test.html'">Back to Dashboard</button>
        </div>
    </div>

    <!-- Edit Form Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditForm()">&times;</span>
            <h2>Edit Truck Details</h2>
            <label>Mileage: <input type="text" id="editMileage"></label>
            <label>Engine Type: <input type="text" id="editEngine"></label>
            <label>Fuel Type: <input type="text" id="editFuel"></label>
            <label>VIN: <input type="text" id="editVIN" disabled></label>
            <label>Title #: <input type="text" id="editTitle"></label>
            <label>Plate #: <input type="text" id="editPlate"></label>
            <label>Registration Exp: <input type="text" id="editRegExp"></label>
            <label>Insurance Exp: <input type="text" id="editInsExp"></label>
            <label>Inspection Exp: <input type="text" id="editInspExp"></label>
            <label>Status:
                <select id="editStatus">
                    <option value="In Operation">In Operation</option>
                    <option value="Out of Service">Out of Service</option>
                </select>
            </label>
            <button class="save-btn" onclick="saveEdits()">Save Changes</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>

        // üîë OAuth 2.0 Credentials
        const CLIENT_ID = "972791277127-g4e3uomcs6diaqdsi1sq7krdclks7mbl.apps.googleusercontent.com";
        const API_KEY = "AIzaSyDVwNNqgEUsxVQtW1vOIoOBhDJ57cVzM6o";
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        // üìä Google Sheets Configuration
        const SHEET_ID = "1uKoi8fGurno_MFjUTghQtr18QThUIhVQMycoAuXSAJE";
        const RANGE = "Sheet1!A1:Z"; // Full Range for Fetching Data

        async function initClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            console.log("‚úÖ Google Sheets API Initialized");

            loadTruckLog(); // ‚úÖ Now safe to call after API initializes
        }

        // üî• Ensure Google API fully loads before calling `initClient()`
        function loadGoogleAPI() {
            gapi.load("client", initClient);
        }

        // üîç Function to Retrieve VIN from URL
        function getVIN() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("vin");
        }

        // üöõ Load Truck Details from Google Sheets
        async function loadTruckLog() {
            const vin = getVIN();
            if (!vin) {
                document.querySelector(".log-container").innerHTML = "<p>üö´ Error: No truck VIN provided.</p>";
                return;
            }

            console.log("üöó Fetching truck details from Google Sheets...");

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: RANGE,
                });

                const data = response.result.values;
                if (!data || data.length < 2) {
                    console.log("üö´ No truck data found in Sheets.");
                    return;
                }

                let sheetData = null;

                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row.length < 10) continue;

                    const vinData = row[9];
                    if (vinData.trim().toLowerCase() === vin.trim().toLowerCase()) {
                        console.log("‚úÖ VIN Matched!");

                        sheetData = {
                            truckTitle: `${row[0]} ${row[1]} ${row[3]}`,
                            color: row[5] || "N/A",
                            mileage: row[6] || "N/A",
                            engine: row[7] || "N/A",
                            fuel: row[8] || "N/A",
                            vin: vinData,
                            title: row[10] || "N/A",
                            plate: row[11] || "N/A",
                            regExp: row[12] || "N/A",
                            insExp: row[13] || "N/A",
                            inspExp: row[14] || "N/A",
                            notes: row[15] ? row[15].split(";") : [],
                            status: sessionStorage.getItem(`status_${vin}`) || "In Operation"
                        };
                        break;
                    }
                }

                if (!sheetData) {
                    console.log("üö´ No matching VIN found.");
                    return;
                }

                // ‚úÖ Merge with existing local data
                const localData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
                const mergedData = {
                    ...sheetData,
                    maintenanceList: localData.maintenanceList || [],
                    repairsList: localData.repairsList || [],
                    notesList: [...new Set([...(localData.notesList || []), ...(sheetData.notes || [])])]
                };

                // ‚úÖ Save merged data to both local and session storage
                localStorage.setItem(`truck_${vin}`, JSON.stringify(mergedData));
                sessionStorage.setItem(`truck_${vin}`, JSON.stringify(mergedData));

                // ‚úÖ Display the updated truck info
                displayTruckData(mergedData);
            } catch (error) {
                console.error("‚ùå Error fetching truck details from Google Sheets:", error);
            }
        }

        function displayTruckData(data) {
            document.getElementById("truckTitle").textContent = data.truckTitle;
            document.getElementById("truckDetails").innerHTML = `
        <p><strong>Mileage:</strong> ${data.mileage} miles</p>
        <p><strong>Color:</strong> ${data.color}</p>
        <p><strong>Engine Type:</strong> ${data.engine}</p>
        <p><strong>Fuel Type:</strong> ${data.fuel}</p>
        <p><strong>VIN:</strong> ${data.vin}</p>
        <p><strong>Title #:</strong> ${data.title}</p>
        <p><strong>Plate #:</strong> ${data.plate}</p>
        <p><strong>Registration Exp:</strong> ${data.regExp}</p>
        <p><strong>Insurance Exp:</strong> ${data.insExp}</p>
        <p><strong>Inspection Exp:</strong> ${data.inspExp}</p>
        <p><strong>Status:</strong> <span id="truckStatus" class="status ${data.status === 'In Operation' ? 'in-operation' : 'out-of-service'}">${data.status}</span></p>
    `;

            // ‚úÖ Merge sheet notes with locally stored notes
            const vin = getVIN();
            let localData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
            let sheetNotes = data.notes || [];
            let localNotes = localData.notesList || [];

            // ‚úÖ Combine & deduplicate
            let mergedNotes = [...new Set([...sheetNotes, ...localNotes])];

            // ‚úÖ Save merged notes back to storage
            localData.notesList = mergedNotes;
            localStorage.setItem(`truck_${vin}`, JSON.stringify(localData));
            sessionStorage.setItem(`truck_${vin}`, JSON.stringify(localData));

            // ‚úÖ Render updated notes
            populateList("notesList", mergedNotes);

            // ‚úÖ Populate other logs (from storage only)
            populateList("maintenanceList", localData.maintenanceList || []);
            populateList("repairsList", localData.repairsList || []);
        }

        function addEntry(listId, inputId) {
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if (!text) return;

            const vin = getVIN();
            let storedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
            if (!storedData[listId]) storedData[listId] = [];

            const timestamp = new Date().toLocaleString();
            const entryText = `${text} (Added: ${timestamp})`;

            // ‚úÖ Prevent duplicate entries
            if (!storedData[listId].includes(entryText)) {
                storedData[listId].push(entryText);
            }

            localStorage.setItem(`truck_${vin}`, JSON.stringify(storedData));
            sessionStorage.setItem(`truck_${vin}`, JSON.stringify(storedData));

            populateList(listId, storedData[listId]);
            input.value = "";
        }

        // ‚úÖ Save Changes to Sheets and Update UI
        function saveEdits() {
            const vin = getVIN();
            let storedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};

            // ‚úÖ Get updated values from input fields
            storedData.mileage = document.getElementById("editMileage").value.trim() || "N/A";
            storedData.engine = document.getElementById("editEngine").value.trim() || "N/A";
            storedData.fuel = document.getElementById("editFuel").value.trim() || "N/A";
            storedData.title = document.getElementById("editTitle").value.trim() || "N/A";
            storedData.plate = document.getElementById("editPlate").value.trim() || "N/A";
            storedData.regExp = document.getElementById("editRegExp").value.trim() || "N/A";
            storedData.insExp = document.getElementById("editInsExp").value.trim() || "N/A";
            storedData.inspExp = document.getElementById("editInspExp").value.trim() || "N/A";
            storedData.status = document.getElementById("editStatus").value.trim() || "In Operation";

            // ‚úÖ Save changes to local storage
            localStorage.setItem(`truck_${vin}`, JSON.stringify(storedData));

            // ‚úÖ Update status in sessionStorage to sync with `test.html`
            sessionStorage.setItem(`status_${vin}`, storedData.status);
            localStorage.setItem(`truck_status_${vin}`, storedData.status);
            window.dispatchEvent(new Event("storage")); // ‚úÖ Notify `test.html` that status changed

            // ‚úÖ Update UI immediately after saving
            displayTruckData(storedData);

            // ‚úÖ Close modal
            closeEditForm();

            // ‚úÖ Show success message
            showSuccessMessage("Truck details updated successfully!");
        }

        // ‚úÖ Create a list item with delete functionality
        function createListItem(text, listId) {
            const listItem = document.createElement("li");
            listItem.textContent = text;

            // Add a delete button to each item
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "‚ùå";
            deleteButton.className = "delete-btn";
            deleteButton.onclick = function () {
                deleteEntryFromSheets(listId, text);
            };

            listItem.appendChild(deleteButton);
            listItem.setAttribute("data-entry", text); // Store the entry text for deletion
            return listItem;
        }

        // üìù Populate List from Sheets (Maintenance, Repairs, Notes)
        function populateList(listId, items) {
            const list = document.getElementById(listId);
            list.innerHTML = ""; // ‚úÖ Clear existing list

            const vin = getVIN();
            let storedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
            let sheetNotes = storedData.notes || [];

            if (listId === "notesList") {
                // ‚úÖ Merge sheet notes + user-added notes
                items = [...new Set([...sheetNotes, ...items])];
            }

            if (items && items.length > 0) {
                items.forEach((item, index) => {
                    const li = document.createElement("li");
                    li.textContent = item;
                    li.setAttribute("data-index", index);

                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "‚ùå";
                    deleteButton.className = "delete-btn";
                    deleteButton.onclick = function () {
                        deleteEntry(listId, index);
                    };

                    li.appendChild(deleteButton);
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = "<p>No entries available.</p>";
            }

            // ‚ùå REMOVE THIS LINE: applyDeleteHandlers(listId); <- Not defined, not needed
        }

        function deleteEntry(listId, index) {
            const vin = getVIN();
            let storedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};

            if (!storedData[listId] || storedData[listId].length === 0) return;

            // ‚úÖ Remove the correct entry
            let removedEntry = storedData[listId].splice(index, 1)[0]; // Get removed item

            // ‚úÖ Save updated data to both storages
            localStorage.setItem(`truck_${vin}`, JSON.stringify(storedData));
            sessionStorage.setItem(`truck_${vin}`, JSON.stringify(storedData));

            // ‚úÖ Track deleted entries for persistence
            let deletedEntries = JSON.parse(sessionStorage.getItem(`deletedEntries_${vin}`)) || {};
            if (!deletedEntries[listId]) {
                deletedEntries[listId] = [];
            }
            deletedEntries[listId].push(removedEntry);
            sessionStorage.setItem(`deletedEntries_${vin}`, JSON.stringify(deletedEntries));

            // ‚úÖ Update UI immediately
            populateList(listId, storedData[listId]);
        }

        document.body.addEventListener("click", function (event) {
            if (event.target.classList.contains("delete-btn")) {
                let listItem = event.target.closest("li");
                let listId = listItem.parentElement.id;
                let index = parseInt(listItem.getAttribute("data-index"), 10);
                deleteEntry(listId, index);
            }
        });

        function getColumnLetter(listId) {
            switch (listId) {
                case "maintenanceList": return "Q";
                case "repairsList": return "R";
                case "notesList": return "P";
                default: return "";
            }
        }

        async function getExistingNotes(rowIndex) {
            const noteRange = `Sheet1!P${rowIndex}`;

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${noteRange}?key=${API_KEY_READ}`
                );
                const data = await response.json();

                return (data.values && data.values.length > 0) ? data.values[0][0] : ""; // ‚úÖ Return empty string if no notes exist
            } catch (error) {
                console.error("‚ùå Error fetching existing notes:", error);
                return ""; // ‚úÖ Ensure empty string is returned instead of undefined
            }
        }

        function showSuccessMessage(message) {
            let msg = document.createElement("div");
            msg.textContent = message;
            msg.style.position = "fixed";
            msg.style.top = "10px";
            msg.style.right = "10px";
            msg.style.background = "#28a745";
            msg.style.color = "white";
            msg.style.padding = "10px 20px";
            msg.style.borderRadius = "5px";
            msg.style.zIndex = "1000";
            msg.style.boxShadow = "2px 2px 10px rgba(0, 0, 0, 0.3)";

            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }
        // Call this function after any successful update

        // ‚úèÔ∏è Open the Edit Modal
        function openEditForm() {
            const modal = document.getElementById("editModal");
            if (modal) {
                modal.style.display = "flex"; // ‚úÖ Open modal when button is clicked
            }
            prefillEditForm(); // ‚úÖ Ensure truck details populate when opening modal
        }

        // ‚ùå Close the Edit Modal
        function closeEditForm() {
            document.getElementById("editModal").style.display = "none";
        }

        // ‚úÖ Load Data on Page Load
        window.onload = function () {
            const modal = document.getElementById("editModal");
            if (modal) modal.style.display = "none"; // ‚úÖ Ensure modal is hidden on page load

            gapi.load("client", async function () {
                await initClient();
            });

            const vin = getVIN();
            let storedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
            let sessionData = JSON.parse(sessionStorage.getItem(`truck_${vin}`)) || {};

            // ‚úÖ Merge sessionStorage and localStorage, prioritizing session data
            let mergedData = { ...storedData, ...sessionData };

            // ‚úÖ Restore session storage with merged data
            sessionStorage.setItem(`truck_${vin}`, JSON.stringify(mergedData));

            // ‚úÖ Ensure deleted entries stay removed after navigation
            if (sessionStorage.getItem(`deletedEntries_${vin}`)) {
                let deletedEntries = JSON.parse(sessionStorage.getItem(`deletedEntries_${vin}`));

                ["maintenanceList", "repairsList", "notesList"].forEach(listId => {
                    if (deletedEntries[listId]) {
                        mergedData[listId] = mergedData[listId]?.filter(entry => !deletedEntries[listId].includes(entry)) || [];
                    }
                });

                // ‚úÖ Update both localStorage and sessionStorage
                localStorage.setItem(`truck_${vin}`, JSON.stringify(mergedData));
                sessionStorage.setItem(`truck_${vin}`, JSON.stringify(mergedData));
            }

            // ‚úÖ Refresh UI & ensure deletions work immediately
            requestAnimationFrame(() => {
                populateList("maintenanceList", mergedData["maintenanceList"] || []);
                populateList("repairsList", mergedData["repairsList"] || []);
                populateList("notesList", mergedData["notesList"] || []);
            });

            // ‚úÖ Ensure newly added entries are deletable **immediately** on page reload
            setTimeout(() => {
                let lists = ["maintenanceList", "repairsList", "notesList"];
                lists.forEach(listId => {
                    let list = document.getElementById(listId);
                    if (list) {
                        list.querySelectorAll(".delete-btn").forEach(button => {
                            button.onclick = function () {
                                let index = parseInt(button.getAttribute("data-index"), 10);
                                deleteEntry(listId, index);
                            };
                        });
                    }
                });
            }, 100);

            // ‚úÖ Listen for storage changes & sync across navigation
            window.addEventListener("storage", () => {
                let updatedData = JSON.parse(localStorage.getItem(`truck_${vin}`)) || {};
                sessionStorage.setItem(`truck_${vin}`, JSON.stringify(updatedData));

                requestAnimationFrame(() => {
                    populateList("maintenanceList", updatedData["maintenanceList"] || []);
                    populateList("repairsList", updatedData["repairsList"] || []);
                    populateList("notesList", updatedData["notesList"] || []);
                });
            });
        };

        document.getElementById("exportPDF").addEventListener("click", async function () {
            const customerKey = "ac9506"; // Your ScreenshotMachine API Key
            const logContainer = document.querySelector(".log-container"); // The main log area

            // ‚úÖ Retrieve the truck title for naming the file
            let truckTitle = document.getElementById("truckTitle").textContent.trim().replace(/\s+/g, "_") || "Truck_Log";

            // ‚úÖ ScreenshotMachine API URL
            let apiUrl = `https://api.screenshotmachine.com?key=${customerKey}`
                + `&url=${encodeURIComponent(window.location.href)}` // Capture the current page
                + `&device=desktop`
                + `&dimension=1366xfull` // Full-page screenshot
                + `&format=png`
                + `&cacheLimit=0` // Always fresh
                + `&delay=400` // Allow time for elements to load
                + `&zoom=100`
                + `&hide=.bottom-buttons`; // Hide export buttons for clean capture

            // ‚úÖ Trigger API Call
            try {
                let response = await fetch(apiUrl);
                let blob = await response.blob();

                // ‚úÖ Convert blob to downloadable image file
                let a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${truckTitle}_log_screenshot.png`; // Save screenshot with truck name
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                console.log("Screenshot saved as:", a.download);
            } catch (error) {
                console.error("Error capturing screenshot:", error);
            }
        });

        // ‚úÖ Add 'Enter' key functionality for all entry inputs
        ["maintenanceInput", "repairInput", "notesInput"].forEach(inputId => {
            const inputField = document.getElementById(inputId);
            inputField.addEventListener("keydown", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // Prevent form submission or unwanted behavior
                    if (inputId === "maintenanceInput") {
                        addEntry("maintenanceList", "maintenanceInput");
                    } else if (inputId === "repairInput") {
                        addEntry("repairsList", "repairInput");
                    } else if (inputId === "notesInput") {
                        addEntry("notesList", "notesInput");
                    }
                }
            });
        });
    </script>
</body>

</html>